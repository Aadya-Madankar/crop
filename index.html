<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåæ Smart Crop Advisor - AI Powered for Indian Farmers</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            color: #333;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 1rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .map-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .map-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        #map {
            height: 500px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .crops-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .location-badge {
            background: #667eea;
            color: white;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .crops-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            max-height: 450px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .crops-grid::-webkit-scrollbar {
            width: 6px;
        }

        .crops-grid::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .crop-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .crop-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .crop-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .crop-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #333;
        }

        .crop-emoji {
            font-size: 2rem;
        }

        .crop-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-ml {
            background: #4caf50;
            color: white;
        }

        .badge-web {
            background: #2196f3;
            color: white;
        }

        .badge-both {
            background: #9c27b0;
            color: white;
        }

        .badge-confidence {
            background: #ff9800;
            color: white;
        }

        .price-display {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .price-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
        }

        .price-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #4caf50;
        }

        .price-range {
            font-size: 0.8rem;
            color: #999;
            margin-top: 4px;
        }

        .click-hint {
            text-align: center;
            color: #667eea;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 30px auto;
            width: 95%;
            max-width: 1100px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: modalSlide 0.3s;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 2rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .chart-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .chart-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .calculator-section {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .calculator-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 20px;
        }

        .slider-container {
            margin: 20px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #4caf50;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #4caf50;
            cursor: pointer;
        }

        .details-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .details-section h2 {
            font-size: 1.3rem;
            color: #667eea;
            margin-top: 25px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .details-section h3 {
            font-size: 1.1rem;
            color: #764ba2;
            margin-top: 20px;
            margin-bottom: 12px;
        }

        .details-section h4 {
            font-size: 1rem;
            color: #555;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .details-section p {
            margin-bottom: 15px;
            line-height: 1.8;
        }

        .details-section ul {
            margin: 15px 0 15px 25px;
            padding: 0;
        }

        .details-section li {
            margin-bottom: 10px;
            line-height: 1.7;
        }

        .details-section strong {
            color: #333;
            font-weight: 600;
        }

        .sources-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #2196f3;
        }

        .sources-title {
            font-weight: 600;
            color: #1565c0;
            margin-bottom: 15px;
        }

        .source-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .source-link {
            color: #2196f3;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .source-link:hover {
            text-decoration: underline;
        }

        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .crops-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåæ Smart Crop Advisor</h1>
            <p>AI-Powered Crop Recommendations with Real Market Data for Indian Farmers</p>
        </div>

        <div class="main-grid">
            <div class="map-card">
                <div class="map-title">üìç Select Your Location on Map</div>
                <div id="map"></div>
            </div>

            <div class="crops-section">
                <div class="section-header">
                    <div class="section-title">üå± Recommended Crops</div>
                    <div class="location-badge" id="location-display">Select location</div>
                </div>
                
                <div id="crops-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">üó∫Ô∏è</div>
                        <h3>Click anywhere on the map to get started</h3>
                        <p>Our AI will analyze your location and recommend the best crops</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">Loading...</div>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modal-body">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Searching the web for latest information...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        const map = L.map('map').setView([20.5937, 78.9629], 5);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        let marker, currentLocation = {}, currentCrops = [];

        const cropEmojis = {
            'Rice': 'üåæ', 'Wheat': 'üåæ', 'Cotton': '‚òÅÔ∏è', 'Sugarcane': 'üéã',
            'Soybean': 'ü´ò', 'Maize': 'üåΩ', 'Jowar': 'üåæ', 'Bajra': 'üåæ',
            'Groundnut': 'ü•ú', 'Onion': 'üßÖ', 'Tomato': 'üçÖ', 'Potato': 'ü•î',
            'Chilli': 'üå∂Ô∏è', 'Turmeric': 'üü°', 'Pulses': 'ü´ò'
        };

        map.on('click', async function(e) {
            const {lat, lng} = e.latlng;
            
            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lng]).addTo(map);
            
            currentLocation = {lat, lng};
            
            document.getElementById('crops-container').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing location and searching for crops...</p>
                </div>
            `;

            try {
                const res = await fetch('http://localhost:8000/recommend', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({latitude: lat, longitude: lng})
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || 'Failed to get recommendations');
                }

                const data = await res.json();
                displayCrops(data);
            } catch (err) {
                document.getElementById('crops-container').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h3>Error: ${err.message}</h3>
                        <p>Please make sure you select a location in India</p>
                    </div>
                `;
            }
        });

        function displayCrops(data) {
            currentCrops = data.crops;
            
            const loc = data.location;
            document.getElementById('location-display').textContent = 
                `${loc.district}, ${loc.state}`;
            
            const cropsHtml = data.crops.map(crop => {
                const emoji = cropEmojis[crop.name] || 'üå±';
                let sourceBadge = '';
                
                if (crop.source === 'Both') {
                    sourceBadge = '<span class="badge badge-both">‚úÖ ML + Web</span>';
                } else if (crop.source.includes('Web')) {
                    sourceBadge = '<span class="badge badge-web">üåê Web Found</span>';
                } else {
                    sourceBadge = '<span class="badge badge-ml">ü§ñ AI Predicted</span>';
                }
                
                const pricePerKg = (crop.current_price / 100).toFixed(2);
                const minPriceKg = (crop.price_range.min / 100).toFixed(2);
                const maxPriceKg = (crop.price_range.max / 100).toFixed(2);
                
                return `
                    <div class="crop-card" onclick="showCropDetails('${crop.name}')">
                        <div class="crop-header">
                            <div class="crop-name">${crop.name}</div>
                            <div class="crop-emoji">${emoji}</div>
                        </div>
                        <div class="crop-badges">
                            ${sourceBadge}
                            <span class="badge badge-confidence">${(crop.confidence * 100).toFixed(0)}% Match</span>
                        </div>
                        <div class="price-display">
                            <div class="price-label">Current Market Price</div>
                            <div class="price-value">‚Çπ${pricePerKg}/kg</div>
                            <div class="price-range">Range: ‚Çπ${minPriceKg} - ‚Çπ${maxPriceKg} per kg</div>
                        </div>
                        <div class="click-hint">Click for detailed analysis ‚Üí</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('crops-container').innerHTML = `
                <div class="crops-grid">${cropsHtml}</div>
            `;
        }

        async function showCropDetails(cropName) {
            const modal = document.getElementById('modal');
            modal.style.display = 'block';
            
            const loc = document.getElementById('location-display').textContent;
            document.getElementById('modal-title').textContent = `${cropName} - Complete Analysis`;
            document.getElementById('modal-body').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Searching Google for latest ${cropName} data...</p>
                    <p style="font-size: 0.9rem; color: #999; margin-top: 10px;">Generating price chart and gathering information...</p>
                </div>
            `;

            try {
                const res = await fetch('http://localhost:8000/crop-details', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        crop_name: cropName,
                        latitude: currentLocation.lat,
                        longitude: currentLocation.lng,
                        location_name: loc
                    })
                });

                const data = await res.json();
                displayCropDetails(data);
            } catch (err) {
                document.getElementById('modal-body').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h3>Error loading details</h3>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        }

        function displayCropDetails(data) {
            const pricing = data.pricing;
            const timeline = data.timeline;
            
            const currentPricePerKg = pricing.price_per_kg;
            const futurePricePerKg = pricing.future_price_per_kg;
            
            // Convert markdown to HTML
            let formattedInfo = data.detailed_info
                .replace(/^### (.*$)/gim, '<h4>$1</h4>')
                .replace(/^## (.*$)/gim, '<h3>$1</h3>')
                .replace(/^# (.*$)/gim, '<h2>$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^\* (.*$)/gim, '<li>$1</li>')
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            formattedInfo = formattedInfo.replace(/(<li>.*?<\/li>)+/gs, '<ul>$&</ul>');
            formattedInfo = '<p>' + formattedInfo + '</p>';
            
            const html = `
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-label">Current Price</div>
                        <div class="info-value">‚Çπ${currentPricePerKg.toFixed(2)}</div>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">per kg</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Future Price</div>
                        <div class="info-value" style="color: #4caf50;">‚Çπ${futurePricePerKg.toFixed(2)}</div>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">per kg (at selling date)</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Days to Harvest</div>
                        <div class="info-value">${timeline.days_to_harvest}</div>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">days</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Selling Date</div>
                        <div class="info-value" style="font-size: 1.2rem;">${timeline.selling_date}</div>
                    </div>
                </div>

                ${data.chart_image ? `
                    <div class="chart-container">
                        <div class="chart-title">üìà Price Trend & Future Prediction</div>
                        <img src="${data.chart_image}" alt="Price Chart" class="chart-image">
                    </div>
                ` : ''}

                <div class="calculator-section">
                    <div class="calculator-title">üí∞ Revenue Calculator</div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>Production Quantity</span>
                            <span id="production-amount">50 kg</span>
                        </div>
                        <input type="range" min="1" max="100" value="50" step="1" class="slider" id="production-slider">
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #999; margin-top: 5px;">
                            <span>1 kg</span>
                            <span>100 kg</span>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 10px; margin-top: 15px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">If you sell TODAY (current market price):</div>
                        <div style="font-size: 1.8rem; font-weight: 700; color: #ff9800;" id="revenue-today">‚Çπ${(currentPricePerKg * 50).toLocaleString('en-IN')}</div>
                        <div style="font-size: 0.85rem; color: #999; margin-top: 3px;">At ‚Çπ${currentPricePerKg.toFixed(2)} per kg</div>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 10px; margin-top: 10px;">
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">If you sell AFTER HARVEST (${timeline.selling_date}):</div>
                        <div style="font-size: 1.8rem; font-weight: 700; color: #4caf50;" id="revenue-future">‚Çπ${(futurePricePerKg * 50).toLocaleString('en-IN')}</div>
                        <div style="font-size: 0.85rem; color: #999; margin-top: 3px;">At ‚Çπ${futurePricePerKg.toFixed(2)} per kg (predicted)</div>
                    </div>
                    
                    <div style="background: ${futurePricePerKg >= currentPricePerKg ? '#e8f5e9' : '#ffebee'}; padding: 15px; border-radius: 10px; margin-top: 10px; border-left: 4px solid ${futurePricePerKg >= currentPricePerKg ? '#4caf50' : '#f44336'};">
                        <div style="font-size: 0.9rem; font-weight: 600; color: ${futurePricePerKg >= currentPricePerKg ? '#2e7d32' : '#c62828'};" id="profit-label">
                            ${futurePricePerKg >= currentPricePerKg ? 'üìà Expected Profit' : 'üìâ Expected Loss'}
                        </div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: ${futurePricePerKg >= currentPricePerKg ? '#4caf50' : '#f44336'}; margin-top: 5px;" id="profit-value">
                            ${futurePricePerKg >= currentPricePerKg ? '+' : ''}‚Çπ${((futurePricePerKg - currentPricePerKg) * 50).toLocaleString('en-IN')}
                        </div>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                            ${futurePricePerKg >= currentPricePerKg ? 
                                '‚úÖ Good time to plant - prices expected to rise' : 
                                '‚ö†Ô∏è Prices may fall - consider waiting or other crops'}
                        </div>
                    </div>
                    
                    <div style="font-size: 0.8rem; color: #999; margin-top: 15px; text-align: center;">
                        üí° Prices are predictions based on historical trends. Always verify with local mandi.
                    </div>
                </div>

                <div class="details-section">
                    <h3>üìã Complete Growing Guide</h3>
                    <div style="line-height: 1.8; color: #555;">
                        ${formattedInfo}
                    </div>
                </div>

                ${data.sources && data.sources.length > 0 ? `
                    <div class="sources-section">
                        <div class="sources-title">üåê Information Sources (${data.sources.length})</div>
                        ${data.sources.map(s => `
                            <div class="source-item">
                                <a href="${s.url}" target="_blank" class="source-link">${s.title}</a>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                <div style="text-align: center; padding: 20px; color: #999; font-size: 0.9rem;">
                    Generated: ${data.generated_at}<br>
                    <strong>Note:</strong> Always verify prices with local mandis and consult agricultural officers.
                </div>
            `;
            
            document.getElementById('modal-body').innerHTML = html;
            
            const slider = document.getElementById('production-slider');
            const amountDisplay = document.getElementById('production-amount');
            const revenueTodayDisplay = document.getElementById('revenue-today');
            const revenueFutureDisplay = document.getElementById('revenue-future');
            const profitValueDisplay = document.getElementById('profit-value');
            
            slider.oninput = function() {
                const quantityKg = parseInt(this.value);
                amountDisplay.textContent = quantityKg + ' kg';
                
                const revenueToday = quantityKg * currentPricePerKg;
                revenueTodayDisplay.textContent = '‚Çπ' + revenueToday.toLocaleString('en-IN');
                
                const revenueFuture = quantityKg * futurePricePerKg;
                revenueFutureDisplay.textContent = '‚Çπ' + revenueFuture.toLocaleString('en-IN');
                
                const profitLoss = revenueFuture - revenueToday;
                profitValueDisplay.textContent = (profitLoss >= 0 ? '+' : '') + '‚Çπ' + profitLoss.toLocaleString('en-IN');
            };
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        window.onclick = function(e) {
            if (e.target.id === 'modal') closeModal();
        }
    </script>


<!-- ==================== AGENTIC BROWSER SEARCH UI ==================== -->

<!-- Browser Preview Modal -->
<div id="browser-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 99999; overflow-y: auto;">
    <div style="max-width: 1200px; margin: 50px auto; background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%); border-radius: 15px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">

        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #4caf50; padding-bottom: 15px;">
            <h2 style="margin: 0; color: #4caf50; font-size: 26px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 32px;">ü§ñ</span>
                <span>Agentic Browser Search</span>
            </h2>
            <button onclick="closeModal()" style="background: linear-gradient(135deg, #f44336, #e53935); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; box-shadow: 0 4px 15px rgba(244,67,54,0.3); transition: all 0.3s;">
                ‚úï Close
            </button>
        </div>

        <!-- Status Section -->
        <div style="background: linear-gradient(135deg, #263238 0%, #37474f 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid #4caf50;">
            <div id="status-text" style="color: #4caf50; font-size: 16px; font-weight: bold; margin-bottom: 12px; display: flex; align-items: center; gap: 10px;">
                <span style="display: inline-block; width: 16px; height: 16px; border: 3px solid #4caf50; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span>
                Ready to search...
            </div>
            <div style="width: 100%; background: #1e1e1e; height: 10px; border-radius: 5px; overflow: hidden; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);">
                <div id="progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a); transition: width 0.5s ease;"></div>
            </div>
        </div>

        <!-- Live Logs Section -->
        <div style="background: #0a0a0a; padding: 20px; border-radius: 10px; min-height: 350px; margin-bottom: 20px; border: 2px solid #333;">
            <div style="color: #888; font-family: 'Courier New', monospace; font-size: 13px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #333;">
                <span style="color: #4caf50;">‚óè</span> Live Logs
            </div>
            <div id="live-logs" style="color: #0f0; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.8; max-height: 300px; overflow-y: auto;"></div>
        </div>

        <!-- Results Section -->
        <div id="results-area" style="display: none; margin-top: 20px;">
            <h3 style="color: #4caf50; margin-bottom: 15px; font-size: 20px; display: flex; align-items: center; gap: 10px;">
                <span>üìä</span> Search Results
            </h3>
            <div id="results-content" style="background: linear-gradient(135deg, #263238 0%, #37474f 100%); padding: 20px; border-radius: 10px; border-left: 5px solid #4caf50;"></div>
        </div>

    </div>
</div>

<!-- Test Button (place this where you want the trigger button) -->
<div style="text-align: center; margin: 40px auto; max-width: 600px;">
    <button onclick="launchSearch('Rice', 'Pune', 'Maharashtra')" 
            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                   color: white; 
                   padding: 18px 40px; 
                   border: none; 
                   border-radius: 12px; 
                   font-size: 18px; 
                   font-weight: bold; 
                   cursor: pointer; 
                   box-shadow: 0 8px 25px rgba(102,126,234,0.4);
                   transition: all 0.3s;
                   display: inline-flex;
                   align-items: center;
                   gap: 12px;"
            onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 12px 35px rgba(102,126,234,0.6)';"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(102,126,234,0.4)';">
        <span style="font-size: 24px;">ü§ñ</span>
        <span>Launch Agentic Browser Search</span>
    </button>
    <p style="color: #666; font-size: 14px; margin-top: 15px;">
        Watch the AI agent search the web in real-time
    </p>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

#live-logs::-webkit-scrollbar {
    width: 8px;
}

#live-logs::-webkit-scrollbar-track {
    background: #1e1e1e;
    border-radius: 4px;
}

#live-logs::-webkit-scrollbar-thumb {
    background: #4caf50;
    border-radius: 4px;
}

#live-logs::-webkit-scrollbar-thumb:hover {
    background: #66bb6a;
}
</style>

<script>
// ==================== WEBSOCKET CLIENT FOR AGENTIC SEARCH ====================

let ws = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;

function initWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/browser-stream`;

    console.log('üîå Connecting to WebSocket:', wsUrl);

    try {
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            console.log('‚úÖ WebSocket connected');
            reconnectAttempts = 0;
            addLog('‚úÖ Connected to server');
        };

        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                console.log('üì® Received:', data.type);
                handleMessage(data);
            } catch (error) {
                console.error('Failed to parse message:', error);
            }
        };

        ws.onerror = (error) => {
            console.error('‚ùå WebSocket error:', error);
            addLog('‚ö†Ô∏è Connection error occurred');
        };

        ws.onclose = () => {
            console.log('üîå WebSocket closed');

            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = 2000 * reconnectAttempts;
                console.log(`üîÑ Reconnecting in ${delay/1000}s... (${reconnectAttempts}/${maxReconnectAttempts})`);
                setTimeout(initWebSocket, delay);
            }
        };

    } catch (error) {
        console.error('Failed to create WebSocket:', error);
    }
}

function handleMessage(data) {
    const statusText = document.getElementById('status-text');
    const progressBar = document.getElementById('progress-bar');

    if (!statusText || !progressBar) return;

    switch(data.type) {
        case 'connection_established':
            addLog('‚úÖ ' + (data.status || 'Connected'));
            break;

        case 'browser_status':
            statusText.innerHTML = `<span style="display: inline-block; width: 16px; height: 16px; border: 3px solid #4caf50; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> ${data.status}`;
            progressBar.style.width = (data.progress || 0) + '%';
            addLog('üìç ' + data.status);

            if (data.progress >= 100) {
                setTimeout(() => {
                    statusText.innerHTML = '‚úÖ ' + data.status;
                }, 500);
            }
            break;

        case 'search_status':
            statusText.innerHTML = `<span style="display: inline-block; width: 16px; height: 16px; border: 3px solid #4caf50; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> ${data.status}`;
            addLog('üîç ' + data.status);
            if (data.query) addLog('üìù Query: ' + data.query);
            break;

        case 'search_complete':
            statusText.innerHTML = `‚úÖ Found ${data.results_count || 0} results`;
            progressBar.style.width = '100%';
            addLog(`‚úÖ Search complete! Found ${data.results_count || 0} results`);

            if (data.results && data.results.length > 0) {
                displayResults(data.results);
            }
            break;

        case 'search_results':
            addLog('üéâ Data extraction complete!');
            statusText.innerHTML = '‚úÖ All tasks completed';
            progressBar.style.width = '100%';

            if (data.results && data.results.length > 0) {
                displayFinalResults(data.results);
            }
            break;

        case 'error':
            const errorMsg = data.error || data.message || 'Unknown error';
            statusText.innerHTML = '‚ùå Error: ' + errorMsg;
            addLog('‚ùå Error: ' + errorMsg);
            progressBar.style.width = '100%';
            progressBar.style.background = 'linear-gradient(90deg, #f44336, #e53935)';
            break;
    }
}

function addLog(message) {
    const logs = document.getElementById('live-logs');
    if (!logs) return;

    const time = new Date().toLocaleTimeString();
    const logLine = document.createElement('div');
    logLine.style.cssText = 'margin-bottom: 8px; padding: 8px 12px; background: rgba(76,175,80,0.1); border-radius: 4px; border-left: 3px solid #4caf50;';
    logLine.innerHTML = `<span style="color: #888;">[${time}]</span> <span style="color: #4caf50;">${message}</span>`;
    logs.appendChild(logLine);
    logs.scrollTop = logs.scrollHeight;
}

function displayResults(results) {
    const resultsArea = document.getElementById('results-area');
    const resultsContent = document.getElementById('results-content');

    if (!resultsArea || !resultsContent) return;

    resultsArea.style.display = 'block';
    resultsContent.innerHTML = '';

    results.forEach((result, index) => {
        const div = document.createElement('div');
        div.style.cssText = 'background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%); padding: 20px; margin-bottom: 15px; border-radius: 10px; border-left: 5px solid #4caf50; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.2s;';
        div.onmouseenter = () => div.style.transform = 'translateX(5px)';
        div.onmouseleave = () => div.style.transform = 'translateX(0)';

        div.innerHTML = `
            <h4 style="margin: 0 0 10px 0; color: #4caf50; font-size: 16px; display: flex; align-items: center; gap: 10px;">
                <span style="background: #4caf50; color: #000; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">${index + 1}</span>
                ${result.title || 'Search Result'}
            </h4>
            <p style="margin: 0 0 10px 0; color: #ccc; font-size: 14px; line-height: 1.6;">${result.content || ''}</p>
            ${result.url ? `<a href="${result.url}" target="_blank" style="color: #4caf50; text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 5px;">üîó View Source <span style="font-size: 11px;">‚Üó</span></a>` : ''}
        `;
        resultsContent.appendChild(div);
    });
}

function displayFinalResults(results) {
    const resultsArea = document.getElementById('results-area');
    const resultsContent = document.getElementById('results-content');

    if (!resultsArea || !resultsContent) return;

    resultsArea.style.display = 'block';
    resultsContent.innerHTML = '';

    results.forEach((result, index) => {
        const div = document.createElement('div');
        div.style.cssText = 'background: #1e1e1e; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid #4caf50; font-family: "Courier New", monospace; color: #0f0; font-size: 13px; line-height: 1.8; white-space: pre-wrap; overflow-x: auto;';
        div.textContent = typeof result === 'string' ? result : JSON.stringify(result, null, 2);
        resultsContent.appendChild(div);
    });
}

function launchSearch(crop, district, state) {
    console.log(`üöÄ Launching search: ${crop} in ${district}, ${state}`);

    // Show modal
    const modal = document.getElementById('browser-modal');
    if (!modal) {
        console.error('‚ùå Modal not found!');
        alert('Browser modal not found in HTML!');
        return;
    }

    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';

    // Reset UI
    document.getElementById('status-text').innerHTML = '<span style="display: inline-block; width: 16px; height: 16px; border: 3px solid #4caf50; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Connecting...';
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-bar').style.background = 'linear-gradient(90deg, #4caf50, #8bc34a)';
    document.getElementById('live-logs').innerHTML = '';
    document.getElementById('results-area').style.display = 'none';

    addLog('üöÄ Initializing agentic browser search...');
    addLog(`üìç Target: ${crop} in ${district}, ${state}`);

    // Connect WebSocket if needed
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        addLog('üîå Establishing WebSocket connection...');
        initWebSocket();

        let attempts = 0;
        const checkConnection = setInterval(() => {
            attempts++;
            if (ws && ws.readyState === WebSocket.OPEN) {
                clearInterval(checkConnection);
                addLog('‚úÖ Connection established');
                sendSearchRequest(crop, district, state);
            } else if (attempts > 10) {
                clearInterval(checkConnection);
                addLog('‚ùå Failed to connect after 10 attempts');
            }
        }, 500);
    } else {
        addLog('‚úÖ WebSocket already connected');
        sendSearchRequest(crop, district, state);
    }
}

function sendSearchRequest(crop, district, state) {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        addLog('‚ùå Not connected. Please try again.');
        return;
    }

    addLog('üì§ Sending search request...');

    try {
        ws.send(JSON.stringify({
            type: 'start_search',
            crop_name: crop,
            district: district,
            state: state,
            query: `${crop} crop information`
        }));
        addLog('‚úÖ Request sent successfully');
    } catch (error) {
        console.error('Failed to send request:', error);
        addLog('‚ùå Failed to send request: ' + error.message);
    }
}

function closeModal() {
    const modal = document.getElementById('browser-modal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

// Test function accessible from console
window.testAgenticSearch = function() {
    launchSearch('Rice', 'Pune', 'Maharashtra');
};

// Initialize WebSocket when page loads
document.addEventListener('DOMContentLoaded', () => {
    console.log('üåê Page loaded, initializing WebSocket...');
    setTimeout(initWebSocket, 1000);
});

// Reconnect on visibility change
document.addEventListener('visibilitychange', () => {
    if (!document.hidden && (!ws || ws.readyState !== WebSocket.OPEN)) {
        console.log('üîÑ Page visible, reconnecting...');
        initWebSocket();
    }
});

console.log('‚úÖ Agentic Browser Search UI loaded');
console.log('üí° Call testAgenticSearch() from console to test');
</script>

<!-- ==================== END AGENTIC BROWSER SEARCH UI ==================== -->


</body>
</html>
